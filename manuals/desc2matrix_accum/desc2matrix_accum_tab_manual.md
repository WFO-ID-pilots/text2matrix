# desc2matrix_accum_tab.py user manual

This document explains the up-to-date manual for using `desc2matrix_accum_tab.py`, which converts the description text files generated by the `Makefile` into a structured JSON output containing the traits and corresponding values. The difference between `desc2matrix.py` and this script is that this accumulates the list of the names of traits as it processes the species descriptions. This script is also different from `desc2matrix_accum.py` in that it asks the LLM to tabulate the traits of a few species in JSON to generate the initial list of traits, instead of using only the first species to do this.

## Operation

1. Retrieve the initial list of traits from the first few species descriptions in the provided descfile

The model runs the 'tabulation prompt', which asks the LLM to tabulate the traits of the first few species in the descfile. The resulting names of the traits are isolated and saved. The number of species to use in tabulation can be set by the `--initspnum` option, with a default of 3.

2. Retrieve traits from the rest of the species using a growing list of trait names

The names of traits are then fed into the LLM run extracting the traits of the subsequent species. The model is asked to extract the given list of traits, put 'NA' where a given trait is missing in the description, and add any traits that are not in the list but are mentioned in the species description.

3. Update the list of traits if needed

The running list of traits is **only updated if the new list of traits is longer than the previous list**. This is to prevent the list from 'degrading' as the script processes the species. If a particular run fails due to the LLM returning a badly structured output, the list of traits is kept the same for the next species.

## Default prompts

The default prompts are hard-coded in `common_scripts/default_prompts.py`, but can be imported from a text file using the relevant options (see **Arguments**). The tabulation prompt and the general extraction prompt must include one or more of the following special 'markers', as is appropriate:

| Marker | In: | Meaning |
| --- | --- | --- |
| `[DESCRIPTIONS]` | Tabulation prompt | Structured list of species descriptions for initial tabulation |
| `[DESCRIPTION]` | Extraction prompt | Plant description text to compile |
| `[CHARACTER_LIST]` | Extraction prompt | Given list of traits to extract |

### System prompt

<pre>
You are a diligent robot assistant made by a botanist. You have expert knowledge of botanical terminology.
Your goal is to transcribe the given botanical description of plant characteristics into a valid JSON output.
Your answer must be as complete and accurate as possible.
You must answer in valid JSON, with no other text.
</pre>

### Tabulation prompt

<pre>
You are given a botanical description of a few plant species taken from published floras.
You extract the types of characteristics mentioned in the descriptions and their corresponding values, and transcribe them into JSON.
Your answer should be an array of JSON with name of the characteristic, ID of species, and the corresponding values formatted as follows: {"characteristic":(name of characteristic), "values":{(ID of species 1): (value of characteristic for species 1), (ID of species 2): (value of characteristic for species 2), ...}.
(name of characteristic) should be substituted with the name of the characteristic.
(ID of species n) should be substituted with the ID of the nth species.
(value of characteristic for species n) should be substituted with the corresponding characteristic value for the nth species.
The name of every characteristic must be written in lowercase.
Make sure that you surround your final answer with square brackets [ and ] so that it is a valid array.
Do not include any text (e.g. introductory text) other than the valid array of JSON.

Follow the instructions below.

1. Transcribe all the mentioned characteristics relating to the whole plant, such as growth form, reproduction, plant height, and branching.

2. Iterate through every mentioned organs (e.g. leaf and other leaf-like organs, stem, flower, inflorescence, fruit, seed and root) and parts of organs (e.g. stipule, anther, ovary) and transcribe their corresponding characteristics.
You must transcribe the length, width, shape, color, surface texture, surface features, and arrangement of each organ or part of an organ.
Each of these characteristics must be separate. The name of every characteristic relating to an organ or a part of an organ must be formatted as follows: "(name of organ or part of organ) (type of characteristic)", where (name of organ or part of organ) should be substituted with the name of the organ or part of the organ, and (type of characteristic) should be substituted with the specific type of characteristic.

3. If a characteristic is mentioned for one species (e.g. species ID A) but not for another species (e.g. species ID B) you should put "NA" as the corresponding value for species ID B. 

In the final output JSON, try to include all words that appear in the given descriptions, as long as they carry information about the plant species.
Do not make up characteristics that are not mentioned in the descriptions.

Here is an example of how you might transcribe species descriptions:

Description of species ID A: Perennial herb 10-30 cm tall. Fruits ovate, tomentose, yellow when ripe. Leaves alternate, glabrous, deep green.
Description of species ID B: Shrub 1-1.5 m tall. Friuts obovate, red when ripe. Leaves lanceolate, opposite, yellow-green.
Description of species ID C: Annual herb 10-12 cm tall. Fruits flattened, glabrous. Leaves alternate, with serrate margin, mid-green.
JSON output:
[
    {"characteristic": "life history", "values": {"A": "perennial", "B": "perennial", "C": "annual"}},
    {"characteristic": "growth form", "values": {"A": "herb", "B": "shrub", "C": "herb"}},
    {"characteristic": "plant height", "values": {"A": "10-30 cm", "B": "1-1.5 m", "C": "10-12 cm"}},
    {"characteristic": "fruit shape", "values": {"A": "ovate", "B": "obovate", "C": "flattened"}},
    {"characteristic": "fruit color", "values": {"A": "yellow when ripe", "B": "red when ripe", "C": "NA"}},
    {"characteristic": "fruit surface texture", "values": {"A": "tomentose", "B": "NA", "C": "glabrous"}},
    {"characteristic": "leaf arrangement", "values": {"A": "alternate", "B": "opposite", "C": "alternate"}},
    {"characteristic": "leaf surface texture", "values": {"A": "glabrous", "B": "NA", "C": "NA"}},
    {"characteristic": "leaf margin shape", "values": {"A": "NA", "B": "NA", "C": "serrate"}},
    {"characteristic": "leaf shape", "values": {"A": "NA", "B": "lanceolate", "C": "NA"}},
    {"characteristic": "leaf color", "values": {"A": "deep green", "B": "yellow-green", "C": "mid-green"}},
]

Here are the descriptions that you should transcribe:

[DESCRIPTIONS]
</pre>

### Extraction prompt

<pre>
You are given a botanical description of a plant species taken from published floras.
You extract the types of characteristics mentioned in the description and their corresponding values, and transcribe them into JSON.
Your answer should be an array of JSON with name of the characteristic and the corresponding value formatted as follows: {"characteristic":(name of characteristic), "value":(value of characteristic)}.
(name of characteristic) should be substituted with the name of the characteristic, and (value of characteristic) should be substituted with the corresponding value.
The name of every characteristic must be written in lowercase.
Make sure that you surround your final answer with square brackets [ and ] so that it is a valid array.
Do not include any text (e.g. introductory text) other than the valid array of JSON.

Follow the instructions below.

1. Transcribe all the mentioned characteristics relating to the whole plant, such as growth form, reproduction, plant height, and branching.

2. Iterate through every mentioned organs (e.g. leaf and other leaf-like organs, stem, flower, inflorescence, fruit, seed and root) and parts of organs (e.g. stipule, anther, ovary) and transcribe their corresponding characteristics.
You must transcribe the length, width, shape, color, surface texture, surface features, and arrangement of each organ or part of an organ.
Each of these characteristics must be separate. The name of every characteristic relating to an organ or a part of an organ must be formatted as follows: "(name of organ or part of organ) (type of characteristic)", where (name of organ or part of organ) should be substituted with the name of the organ or part of the organ, and (type of characteristic) should be substituted with the specific type of characteristic.

In the final output JSON, try to include all words that appear in the given description, as long as they carry information about the plant species.
Do not make up characteristics that are not mentioned in the description.

Here are some examples of descriptions and their correponding transcription in JSON:

Sentence: "Fruit: ovoid berry, 10-12 mm wide, 13-15 mm long, yellow to yellow-green throughout."
JSON: {"characteristic": "fruit shape", "value": "ovoid"}, {"characteristic": "fruit type", "value": "berry"}, {"characteristic": "fruit width", "value": "10-12 mm"}, {"characteristic": "fruit length", "value": "13-15 mm"}, {"characteristic": "fruit color", "value": "yellow to yellow-green"}

Sentence: "Perennial dioecious herbs 60-100cm tall. Leaves alternate, green and glabrous adaxially and hirsute with white to greyish hair abaxially."
JSON: {"characteristic": "life history", "value": "perennial"}, {"characteristic": "reproduction", "value": "dioecious"}, {"characteristic": "growth form", "value": "herb"}, , {"characteristic": "plant height", "value": "60-100 cm"}, {"characteristic": "leaf arrangement", "value": "alternate"}, {"characteristic": "leaf adaxial colour", "value": "green"}, {"characteristic": "leaf adaxial texture", "value": "glabrous"}, {"characteristic": "leaf abaxial texture", "value": "hirsute"}, {"characteristic": "leaf abaxial hair colour", "value": "white to greyish"}

Include the following list of characteristics in your output. Use the name of the characteristic as given in this list. If you can't find one or more of these characteristics in the given description, put "NA" as the corresponding value. If you find a characteristic in the given description that is not in this list, add that characteristic in your response.

[CHARACTER_LIST]

Here is the description that you should transcribe:

[DESCRIPTION]
</pre>

## Arguments

| Argument | Description | Required? | Default value |
| --- | --- | --- | --- |
| `descfile` (positional argument) | Path to the flora description file to transcribe | Yes | |
| `outputfile` (positional argument) | Path to the output JSON file | Yes | |
| `--desctype` | Name of the 'type' that contains morphological descriptions in the descfile | Yes | |
| `--sysprompt` | Path to a text file containing the system prompt to use | No | See above |
| `--prompt` | Path to a text file containing the general extraction prompt to use | No | See above |
| `--tabprompt` | Path to a text file containing the tabulation prompt to use | No | See above |
| `--silent` | If flag is present, suppress command-line output showing progress | No | `None` |
| `--start` | Order ID (starting from 0) of the species in the descfile to start transcribing from | No | `0` |
| `--spnum` | Number of species to transcribe | No | `None` (transcribe entire file) |
| `--initspnum` | Number of species to use in initial tabulation | No | `3` |
| `--model` | Name of the base LLM to use. Specified LLM must be installed and running at `localhost:11434` | No | `llama3` |
| `--temperature` | Model temperature between 0 and 1. See [here](https://github.com/ollama/ollama/blob/main/docs/modelfile.md) for detailed reference | No | `0.1` |
| `--seed` | Random seed to use for reproducibility. Setting to 0 makes the output random. See [here](https://github.com/ollama/ollama/blob/main/docs/modelfile.md) for detailed reference | No | `1` |
| `--repeatlastn` | Number of tokens(?) the model looks back to prevent repetition. Set to 0 to prevent this behaviour as default. See [here](https://github.com/ollama/ollama/blob/main/docs/modelfile.md) for detailed reference | No | 0 |
| `--numpredict` | Number of tokens for model to generate. See [here](https://github.com/ollama/ollama/blob/main/docs/modelfile.md) for detailed reference | No | `2048` |
| `--numctx` | Size of the context window used to generate the token See [here](https://github.com/ollama/ollama/blob/main/docs/modelfile.md) for detailed reference | No | `4096` |
| `--topk` | Parameter adjusting the degree of 'conservativeness' in the model output. See [here](https://github.com/ollama/ollama/blob/main/docs/modelfile.md) for detailed reference | No | `None` (set to `40` by Ollama) |
| `--topp` | Parameter adjusting the degree of 'conservativeness' in the model output. See [here](https://github.com/ollama/ollama/blob/main/docs/modelfile.md) for detailed reference | No | `None` (set to `0.9` by Ollama) |

## Output

The output is a single JSON object with the following keys:

| Key | Description |
| --- | --- |
| `sys_prompt` | System prompt |
| `tab_prompt` | Tabulation prompt |
| `prompt` | Prompt used subsequent to `tab_prompt` to extract the characteristics |
| `initspnum` | Number of species used for tabulation |
| `params` | Key-value pairs of parameters used for the model run |
| `mode` | 'Mode' used to generate the output. This is set to `desc2json_accum_tab`. |
| `charlist_len_history` | A list containing the length of the lists of characteristics used for each species processed |
| `charlist_history` | A list containing the lists of characteristics used for each species processed |
| `data` | List of JSONs containing transcribed characteristics of each species (see below) |

The `data` list contains JSON objects for every transcribed species, with the following keys:

| Key | Description |
| --- | --- |
| `coreid` | WFO taxon ID of the transcribed species |
| `status` | `success` for successful parse, `invalid_json` for invalid JSON output, `bad_structure` for JSON that's valid but badly structured. |
| `original_description` | The original description imported from WFO |
| `char_json` | List of JSONS containing the transcribed characteristics. Each element is structured as `{"characteristic": name of characteristic, "value": value of characteristic}`. This is `null` if the response failed to parse. |
| `failed_str` | Response string from the LLM that failed to parse to JSON. This is `null` if the response successfully parsed. |